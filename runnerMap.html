<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
        #myMap { width: 100%; height: 100vh; }

        #addEventBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 32px;
            background-color: #0078D4;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        #addEventForm {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            padding: 15px;
            border: 1px solid #ccc;
            z-index: 1000;
            width: 250px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #eventMenu {
            position: fixed;
            bottom: 90px;
            left: 20px;
            z-index: 1000;
            display: none;
        }

        #eventCard {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            width: 250px;
            transition: all 0.3s ease;
        }

        #eventCard h3 {
            margin: 0 0 10px;
        }

        #eventCard button {
            margin-right: 10px;
            margin-top: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            background-color: #0078D4;
            color: white;
            cursor: pointer;
        }

        #eventCard button:last-child {
            background-color: #ccc;
            color: black;
        }
        #userBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            background-color: white;
            color: #333;
            border: 1px solid #ccc;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #userMenu {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
        }

        #userCard {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            width: 250px;
            transition: all 0.3s ease;
        }

        #userCard h3, #userCard h4 {
            margin: 10px 0 5px;
        }

        #userCard ul {
            padding-left: 20px;
            margin: 0;
        }

        #userCard li {
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>

    <script>
        let map;
        function getMap() {
            map = new atlas.Map('myMap', {
                center: [34.8, 32.1],
                zoom: 10,
                view: 'Auto',
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'BSDCG4i6BIsimtM5jNRtCupaIm4boJb8WM92OhKd3jL6x14l3W6mJQQJ99BEACi5YpzPSPD9AAAgAZMP337x',
                }
            });

            map.events.add('ready', function() {
                //window.ReactNativeWebView.postMessage(JSON.stringify({data: {action: 'log', message: 'Map ready'}}));
                //console.log('Map ready');

                 // Wait a short moment to ensure the camera is settled
                window.ReactNativeWebView.postMessage(JSON.stringify({data: {action: 'getEvents'}}));
                window.document.addEventListener('message', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        const { type } = data;
                        
                        if (type === 'eventList') {

                            const { events } = data;

                            // Clear existing markers
                            if (!window.eventMarkers) {
                                window.eventMarkers = [];
                            } else {
                                window.eventMarkers.forEach(marker => map.markers.remove(marker));
                                window.eventMarkers = [];
                            }

                            // Store my events
                            window.myEvents = [];

                            for (let i = 0; i < events.length; i++) {
                                const { latitude, longitude, id, title, userId } = events[i];

                                const marker = new atlas.HtmlMarker({
                                    position: [longitude, latitude],
                                    text: '!'
                                });

                                map.markers.add(marker);
                                window.eventMarkers.push(marker);

                                map.events.add('click', marker, () => {
                                    document.getElementById('eventTitleDisplay').textContent = title || 'Untitled';
                                    document.getElementById('eventCoords').textContent = `Lat: ${latitude}, Lng: ${longitude}`;
                                    window.selectedEventId = id;
                                    document.getElementById('eventMenu').style.display = 'block';
                                });

                                // For now, fake current user as 'me'
                                if (userId === 'me') {
                                    window.myEvents.push({ id, title });
                                }
                            }

                        // Update the "My Events" list
                        const list = document.getElementById('myEventsList');
                        list.innerHTML = '';
                        window.myEvents.forEach(evt => {
                            const li = document.createElement('li');
                            li.textContent = evt.title || '(Untitled)';
                            list.appendChild(li);
                        });

                        } else if (type === 'userLocation') {
                            const { location } = data;

                            if (!window.userMarker) {
                                window.userMarker = new atlas.HtmlMarker({
                                    position: [location.coords.longitude, location.coords.latitude],
                                    text: 'U',
                                    color: 'green'
                                });
                                map.markers.add(window.userMarker);
                            } else {
                                window.userMarker.setOptions({
                                    position: [location.coords.longitude, location.coords.latitude]
                                });
                            }
                        }
                    } catch (err) {
                        console.error('Invalid message recieved: ', err);
                    }
                })
            })
        }
        function handleJoin() {
        const message = {
            data: {
                id: window.selectedEventId,
                action: 'join'
            }
        };
        window.ReactNativeWebView.postMessage(JSON.stringify(message));
    }

        function handleDelete() {
            const message = {
                data: {
                    id: window.selectedEventId,
                    action: 'delete'
                }
            };
            window.ReactNativeWebView.postMessage(JSON.stringify(message));
            getElementById('eventMenu').style.display = 'none';
        }

    function toggleAddEventForm() {
        const form = document.getElementById('addEventForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function submitEvent() {
        const title = document.getElementById('eventTitle').value;
        const latitude = parseFloat(document.getElementById('eventLatitude').value);
        const longitude = parseFloat(document.getElementById('eventLongitude').value);

        if (!title || isNaN(latitude) || isNaN(longitude)) {
            alert('Please fill all fields correctly.');
            return;
        }

        const newEvent = {
            title,
            latitude,
            longitude
        };

        // Send to React Native or your backend as needed
        window.ReactNativeWebView.postMessage(JSON.stringify({
            data: {
                action: 'addEvent',
                event: newEvent
            }
        }));

        toggleAddEventForm();
    }

    let tempMarker = null;
    let trackingCenter = false;

    function startLocationSelection() {
        // Hide the form and show the confirm button
        document.getElementById('addEventForm').style.display = 'none';
        document.getElementById('confirmLocationBtn').style.display = 'inline';

        trackingCenter = true;

        // Drop a marker at the current center
        const center = map.getCamera().center;

        if (!tempMarker) {
            tempMarker = new atlas.HtmlMarker({
                position: center,
                draggable: false,
                color: 'DodgerBlue'
            });
            map.markers.add(tempMarker);
        } else {
            tempMarker.setOptions({ position: center });
        }

        // Move the marker as the map moves
        console.log("Binding move event...");
        map.events.add('move', updateMarkerPosition);
    }

    function updateMarkerPosition() {
        if (trackingCenter && tempMarker) {
            const center = map.getCamera().center;
            console.log("Map moved. Center is:", center);
            window.ReactNativeWebView.postMessage(JSON.stringify({data: {action: 'log', message: 'Map moved'}}));
            tempMarker.setOptions({ position: center });
        }
    }

    function confirmLocation() {
        trackingCenter = false;
        map.events.remove('move', updateMarkerPosition);

        const pos = tempMarker.getOptions().position;
        document.getElementById('eventLatitude').value = pos[1].toFixed(6);
        document.getElementById('eventLongitude').value = pos[0].toFixed(6);

        // Hide confirm button and show form again
        document.getElementById('confirmLocationBtn').style.display = 'none';
        document.getElementById('addEventForm').style.display = 'block';
    }
    function closeEventMenu() {
        document.getElementById('eventMenu').style.display = 'none';
    }
    function toggleUserMenu() {
        const menu = document.getElementById('userMenu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function closeUserMenu() {
        document.getElementById('userMenu').style.display = 'none';
    }
    </script>
</head>
<body onload="getMap()">
    <div id="myMap"></div>

    <div id="eventMenu" style="display: none;">
        <div id="eventCard">
            <h3 id="eventTitleDisplay">Event Title</h3>
            <p id="eventCoords"></p>
            <button onclick="handleJoin()">Join</button>
            <button onclick="handleDelete()">Delete</button>
            <button onclick="closeEventMenu()">Close</button>
        </div>
    </div>
    <button id="addEventBtn" onclick="toggleAddEventForm()">+</button>
    <button id="confirmLocationBtn"
        onclick="confirmLocation()"
        style="display:none; position: fixed; bottom: 90px; right: 20px; z-index: 1000;">
        Confirm Location
    </button>

<div id="addEventForm" style="display:none;">
    <h3>Add New Event</h3>
    <input type="text" id="eventTitle" placeholder="Event Title" /><br />
    <input type="text" id="eventLatitude" placeholder="Latitude" readonly /><br />
    <input type="text" id="eventLongitude" placeholder="Longitude" readonly /><br />
    <button type="button" onclick="startLocationSelection()">Choose Location on Map</button>
    <button onclick="submitEvent()">Submit</button>
    <button onclick="toggleAddEventForm()">Cancel</button>
</div>
<button id="userBtn" onclick="toggleUserMenu()">ðŸ‘¤</button>
<div id="userMenu" style="display:none;">
    <div id="userCard">
        <h3>User Info</h3>
        <p>(Not signed in)</p>

        <h4>My Events</h4>
        <ul id="myEventsList"></ul>

        <button onclick="closeUserMenu()">Close</button>
    </div>
</div>
</body>
</html>