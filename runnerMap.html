<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
        #myMap { width: 100%; height: 100vh; }
    </style>

    <script>
        var map;

        function getMap() {
            map = new atlas.Map('myMap', {
                view: 'Auto',
                center: [34.8, 32.1],
                zoom: 10,
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'BSDCG4i6BIsimtM5jNRtCupaIm4boJb8WM92OhKd3jL6x14l3W6mJQQJ99BEACi5YpzPSPD9AAAgAZMP337x',
                }
            });

            map.events.add('ready', function() {
                window.ReactNativeWebView.postMessage(JSON.stringify({data: {action: 'getEvents'}}));
                window.document.addEventListener('message', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        const { type } = data;

                        if (type === 'eventList') {

                            const { events } = data;

                            //const { latitude, longitude } = data;

                            map.markers.clear();

                            for (let i = 0; i < events.length; i++) {
                                const { latitude, longitude, id, title } = events[i];

                                const marker = new atlas.HtmlMarker({
                                    position: [longitude, latitude],
                                    text: '!'
                                });
                                map.markers.add(marker);

                                // Capture event info for this marker
                                map.events.add('click', marker, () => {
                                    // Show event data in the menu
                                    document.getElementById('eventDetails').textContent = `Event ID: ${id}, Title: ${title || 'Untitled'}`;

                                    // Store the current event ID for the buttons to use
                                    window.selectedEventId = id;

                                    // Show the menu
                                    document.getElementById('eventMenu').style.display = 'block';
                                });
                            }

                            window.ReactNativeWebView.postMessage(JSON.stringify({data: {action: 'getUserLocation'}}));

                        } else if (type === 'userLocation') {
                            const { location } = data;

                            const marker = new atlas.HtmlMarker({
                                position: [location.coords.longitude, location.coords.latitude],
                                text: '?',
                                color: 'Green'
                            });
                            map.markers.add(marker);
                        }
                    } catch (err) {
                        console.error('Invalid message recieved: ', err);
                    }
                })
            })
        }
        function handleJoin() {
        const message = {
            data: {
                id: window.selectedEventId,
                action: 'join'
            }
        };
        window.ReactNativeWebView.postMessage(JSON.stringify(message));
    }

        function handleDelete() {
            const message = {
                data: {
                    id: window.selectedEventId,
                    action: 'delete'
                }
            };
            window.ReactNativeWebView.postMessage(JSON.stringify(message));
            getElementById('eventMenu').style.display = 'none';
        }
    </script>
</head>
<body onload='getMap()'>
    <div id="myMap" style="position:relative; width:100%; min-width:290px; height:600px;"></div>

    <div id="eventMenu" style="display:none; padding:15px; background:#f8f8f8; border-top:1px solid #ccc;">
    <p id="eventDetails"></p>
    <button onclick="handleJoin()">Join</button>
    <button onclick="handleDelete()">Delete</button>
</div>
    
</body>
</html>